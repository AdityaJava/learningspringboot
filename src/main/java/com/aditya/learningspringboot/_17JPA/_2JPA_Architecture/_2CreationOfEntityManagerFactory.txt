package com.example.config;

import com.zaxxer.hikari.HikariDataSource;
import jakarta.persistence.EntityManagerFactory;
import org.springframework.boot.context.properties.ConfigurationProperties;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.data.jpa.repository.config.EnableJpaRepositories;
import org.springframework.orm.jpa.JpaTransactionManager;
import org.springframework.orm.jpa.JpaVendorAdapter;
import org.springframework.orm.jpa.LocalContainerEntityManagerFactoryBean;
import org.springframework.orm.jpa.vendor.HibernateJpaVendorAdapter;
import org.springframework.transaction.PlatformTransactionManager;
import org.springframework.transaction.annotation.EnableTransactionManagement;

import javax.sql.DataSource;
import java.util.Properties;

/**
 * ==========================================================
 * JPA INFRASTRUCTURE CONFIGURATION
 * ==========================================================
 *
 * This class manually wires all JPA components instead of
 * relying on Spring Boot auto-configuration.
 *
 * Useful for:
 *  - Understanding JPA internals
 *  - Multiple databases
 *  - Multi-tenancy
 *  - Interview-level clarity
 */
@Configuration
@EnableTransactionManagement
@EnableJpaRepositories(
        basePackages = "com.example.repository",
        entityManagerFactoryRef = "entityManagerFactory",
        transactionManagerRef = "transactionManager"
)
public class JpaConfig {

    /**
     * ==========================================================
     * 1. DataSource
     * ==========================================================
     *
     * WHY REQUIRED?
     * - DataSource is the factory for DB connections
     * - All DB access starts from DataSource
     * - Hibernate uses DataSource to get JDBC connections
     *
     * WHY HIKARI?
     * - Fastest connection pool
     * - Production default in Spring Boot
     *
     * @ConfigurationProperties:
     * - Binds properties from application.yml
     *   spring.datasource.url
     *   spring.datasource.username
     *   spring.datasource.password
     */
    @Bean
    @ConfigurationProperties(prefix = "spring.datasource")
    public DataSource dataSource() {
        return new HikariDataSource();
    }

    /**
     * ==========================================================
     * 2. JpaVendorAdapter
     * ==========================================================
     *
     * WHY REQUIRED?
     * - JPA is just a specification
     * - Hibernate is the actual implementation
     * - This adapter bridges Spring JPA â†” Hibernate
     *
     * WHAT IT DEFINES?
     * - Database dialect (MySQL, Oracle, Postgres, etc.)
     * - SQL logging
     * - DDL generation behavior
     */
    @Bean
    public JpaVendorAdapter jpaVendorAdapter() {

        HibernateJpaVendorAdapter adapter =
                new HibernateJpaVendorAdapter();

        // Generates DB-specific SQL
        adapter.setDatabasePlatform("org.hibernate.dialect.MySQLDialect");

        // Prints SQL queries in logs
        adapter.setShowSql(true);

        // Prevents Hibernate from auto-creating tables
        adapter.setGenerateDdl(false);

        return adapter;
    }

    /**
     * ==========================================================
     * 3. EntityManagerFactory
     * ==========================================================
     *
     * MOST IMPORTANT JPA COMPONENT
     *
     * KEY RULE:
     * - One Persistence Unit = One EntityManagerFactory
     * - One EntityManagerFactory = Many EntityManagers
     *
     * WHAT IT HOLDS?
     * - DataSource
     * - Entity classes
     * - Hibernate configuration
     *
     * WHY REQUIRED?
     * - Creates EntityManager instances
     * - Without this, JPA cannot work
     */
    @Bean
    public LocalContainerEntityManagerFactoryBean entityManagerFactory(
            DataSource dataSource,
            JpaVendorAdapter jpaVendorAdapter) {

        LocalContainerEntityManagerFactoryBean emf =
                new LocalContainerEntityManagerFactoryBean();

        // DB connection factory
        emf.setDataSource(dataSource);

        // Hibernate as JPA provider
        emf.setJpaVendorAdapter(jpaVendorAdapter);

        // Where @Entity classes are located
        emf.setPackagesToScan("com.example.entity");

        // Logical name of persistence unit
        emf.setPersistenceUnitName("default-persistence-unit");

        // Hibernate specific properties
        emf.setJpaProperties(jpaProperties());

        return emf;
    }

    /**
     * ==========================================================
     * 4. Transaction Manager
     * ==========================================================
     *
     * WHY REQUIRED?
     * - Controls transaction lifecycle
     *   begin()
     *   commit()
     *   rollback()
     *
     * ENABLES:
     * - @Transactional annotation
     *
     * WHAT HAPPENS INTERNALLY?
     * - Before method â†’ start transaction
     * - On success â†’ commit
     * - On exception â†’ rollback
     */
    @Bean
    public PlatformTransactionManager transactionManager(
            EntityManagerFactory entityManagerFactory) {

        return new JpaTransactionManager(entityManagerFactory);
    }

    /**
     * ==========================================================
     * 5. Hibernate / JPA Properties
     * ==========================================================
     *
     * WHY REQUIRED?
     * - Controls Hibernate behavior
     * - Prevents dangerous defaults in production
     */
    private Properties jpaProperties() {

        Properties props = new Properties();

        // Schema management strategy
        props.put("hibernate.hbm2ddl.auto", "none");

        // Pretty SQL logs
        props.put("hibernate.format_sql", true);

        // Prevents timezone-related bugs
        props.put("hibernate.jdbc.time_zone", "UTC");

        return props;
    }
}

ðŸ§  One-line Interview Summary (remember this)

DataSource â†’ DB connections
EntityManagerFactory â†’ Creates EntityManagers
EntityManager â†’ Talks to DB
TransactionManager â†’ Commit / Rollback
JpaVendorAdapter â†’ Hibernate wiring